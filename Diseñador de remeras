<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Remeras Personalizadas</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <style>
    body { font-family: Arial; text-align: center; background: #f4f4f4; margin: 0; padding: 20px; }
    #designer { background: white; margin: 20px auto; border: 2px dashed #ccc; }
    .controls { margin: 20px; }
    select, input, button { margin: 5px; padding: 10px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>Crea tu remera personalizada</h1>
  
  <div class="controls">
    <label>Color de remera:</label>
    <select id="color">
      <option value="#ffffff">Blanca</option>
      <option value="#000000">Negra</option>
      <option value="#ff0000">Roja</option>
      <option value="#0066ff">Azul</option>
      <option value="#ffff00">Amarilla</option>
      <option value="#00ff00">Verde</option>
    </select>

    <input type="file" id="upload" accept="image/*">
    <input type="text" id="texto" placeholder="Tu texto aquí">
    <button onclick="addText()">Agregar texto</button>
    <button onclick="clearCanvas()">Limpiar</button>
    <button onclick="saveDesign()" style="background:#28a745;color:white;">GUARDAR DISEÑO</button>
  </div>

  <canvas id="designer" width="500" height="600"></canvas>

  <script>
    const canvas = new fabric.Canvas('designer', { backgroundColor: '#ffffff' });
    const template = new Image();
    template.src = 'https://i.imgur.com/2YvJ8oE.png'; // plantilla de remera (transparente en el centro)
    template.onload = () => canvas.setBackgroundImage(template, canvas.renderAll.bind(canvas), {
      scaleX: canvas.width / template.width,
      scaleY: canvas.height / template.height
    });

    // Cambiar color de remera
    document.getElementById('color').addEventListener('change', function() {
      canvas.backgroundColor = this.value;
      canvas.renderAll();
    });

    // Subir imagen
    document.getElementById('upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function(f) {
        fabric.Image.fromURL(f.target.result, img => {
          img.scaleToWidth(200);
          img.set({ left: 150, top: 150 });
          canvas.add(img);
          canvas.setActiveObject(img);
        });
      };
      reader.readAsDataURL(file);
    });

    function addText() {
      const text = document.getElementById('texto').value || "Tu texto";
      const fabricText = new fabric.Text(text, {
        left: 100, top: 100, fontSize: 40, fill: '#000000', fontFamily: 'Arial'
      });
      canvas.add(fabricText);
      canvas.setActiveObject(fabricText);
    }

    function clearCanvas() {
      canvas.clear();
      canvas.backgroundColor = document.getElementById('color').value;
      canvas.setBackgroundImage(template, canvas.renderAll.bind(canvas), {
        scaleX: canvas.width / template.width,
        scaleY: canvas.height / template.height
      });
    }

    async function saveDesign() {
      const dataURL = canvas.toDataURL({ format: 'png' });
      const json = JSON.stringify(canvas.toJSON());

      const res = await fetch('/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image: dataURL, json: json })
      });

      const result = await res.json();
      if (result.success) {
        alert(`¡Diseño guardado! ID: ${result.id}\nCompartilo con tu cliente o miralo en el panel de admin.`);
      }
    }
  </script>
</body>
</html>
